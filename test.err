[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (25, 10)
[DEBUG] First 3 embedding indices: ['CoV-140.1-Su', 'CoV-167.2-Su', 'CoV-181.1-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=25, meta_only=516, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.1-Wilk', 'CoV-1.2-Wilk', 'CoV-100.1-Su', 'CoV-100.2-Su', 'CoV-101.1-Su']
[DEBUG] After alignment: meta_df=(25, 6), embedding_df=(25, 10)
[DEBUG] Dropped rows -> meta: 516, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.25223372 0.14450597]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (6): ['Mudd', 'SS1', 'SS2', 'Su', 'Wilk', 'Zhu']
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 25 samples

Merging data...
  Merged data: 25 samples retained

Performing ANOVA...
  Analyzing 25 samples with complete data
  Number of batches: 6
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 6.7778e-04 (η² = 0.858)
  Severity Effect: p = 2.3700e-04 (η² = 0.821)
  Interaction: p = 6.1013e-01 (η² = 0.440)
  Overall Assessment: MODERATE
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 25
Batches: 6 -> ['Mudd', 'SS1', 'SS2', 'Su', 'Wilk', 'Zhu']

iLISI (mean ± sd): 2.1778 ± 0.8990
iLISI_norm: 0.3630
ASW-batch: 0.6365

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 25
Samples with valid severity: 25
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): -0.0088
Normalized Mutual Info (NMI): 0.1855
Average Cluster Purity: 0.8409

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 25 samples

Merging data...
  Merged data: 25 samples retained

Calculating Spearman correlation...
  Analyzing 25 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.5698 (p = 2.9440e-03)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 16 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq    df         F    PR(>F)
C(Q('sev.level'))  0.169372   3.0  3.218488  0.061399
Residual           0.210499  12.0       NaN       NaN
SciPy F-test: F=3.2185, p=0.0614
Effect sizes: eta²=0.4459, ω²=0.2938

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su      16
SS1      4
Mudd     2
Wilk     1
SS2      1
Zhu      1
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 6, n_non_anchor = 9

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 9
Anchor samples: 16
Pool samples: 9
k_neighbors: 1

Results for 'SD_expression':
  Mean |Δseverity|: 0.9375
  95% CI: [0.5625, 1.3125]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (50, 10)
[DEBUG] First 3 embedding indices: ['HD-13-Lee', 'CoV-212.3-Zhu', 'CoV-62.3-SS2']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=50, meta_only=491, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.1-Wilk', 'CoV-100.1-Su', 'CoV-100.2-Su', 'CoV-101.1-Su', 'CoV-101.2-Su']
[DEBUG] After alignment: meta_df=(50, 6), embedding_df=(50, 10)
[DEBUG] Dropped rows -> meta: 491, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.17382388 0.14135689]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (10): ['Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 50 samples

Merging data...
  Merged data: 50 samples retained

Performing ANOVA...
  Analyzing 50 samples with complete data
  Number of batches: 10
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 3.5866e-07 (η² = 0.868)
  Severity Effect: p = 1.0000e+00 (η² = -0.000)
  Interaction: p = 3.4890e-04 (η² = 0.783)
  Overall Assessment: POOR
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 50
Batches: 10 -> ['Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.4854 ± 1.7674
iLISI_norm: 0.2485
ASW-batch: 0.6797

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 50
Samples with valid severity: 50
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0246
Normalized Mutual Info (NMI): 0.1284
Average Cluster Purity: 0.8457

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 50 samples

Merging data...
  Merged data: 50 samples retained

Calculating Spearman correlation...
  Analyzing 50 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.5684 (p = 1.6628e-05)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 29 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq    df         F    PR(>F)
C(Q('sev.level'))  0.028091   3.0  1.181938  0.336613
Residual           0.198059  25.0       NaN       NaN
SciPy F-test: F=1.1819, p=0.3366
Effect sizes: eta²=0.1242, ω²=0.0185

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        29
SS2        6
SS1        5
Zhu        3
Wen        2
Wilk       1
Lee        1
Yu         1
Silvin     1
Mudd       1
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 10, n_non_anchor = 21

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 21
Anchor samples: 29
Pool samples: 21
k_neighbors: 1

Results for 'SD_expression':
  Mean |Δseverity|: 1.4483
  95% CI: [1.1034, 1.7931]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (100, 10)
[DEBUG] First 3 embedding indices: ['CoV-117.1-Su', 'CoV-130.2-Su', 'CoV-139.2-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=100, meta_only=441, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.2-Wilk', 'CoV-100.2-Su', 'CoV-101.1-Su', 'CoV-101.2-Su', 'CoV-102.1-Su']
[DEBUG] After alignment: meta_df=(100, 6), embedding_df=(100, 10)
[DEBUG] Dropped rows -> meta: 441, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.26787831 0.15668858]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (11): ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 100 samples

Merging data...
  Merged data: 100 samples retained

Performing ANOVA...
  Analyzing 100 samples with complete data
  Number of batches: 11
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 5.0684e-03 (η² = 0.523)
  Severity Effect: p = 1.0000e+00 (η² = 0.000)
  Interaction: p = 8.9783e-01 (η² = 0.177)
  Overall Assessment: POOR
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 100
Batches: 11 -> ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.2352 ± 1.5071
iLISI_norm: 0.2032
ASW-batch: 0.5265

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 100
Samples with valid severity: 100
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): -0.0059
Normalized Mutual Info (NMI): 0.0470
Average Cluster Purity: 0.8454

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 100 samples

Merging data...
  Merged data: 100 samples retained

Calculating Spearman correlation...
  Analyzing 100 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.5885 (p = 1.2010e-10)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 62 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq    df          F        PR(>F)
C(Q('sev.level'))  0.824025   3.0  19.377382  7.975940e-09
Residual           0.822152  58.0        NaN           NaN
SciPy F-test: F=19.3774, p=7.976e-09
Effect sizes: eta²=0.5006, ω²=0.4707

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        62
SS2       13
Lee        4
Zhu        4
Aruna      4
SS1        4
Wilk       3
Wen        2
Mudd       2
Yu         1
Silvin     1
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 11, n_non_anchor = 38

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 38
Anchor samples: 62
Pool samples: 38
k_neighbors: 1

Results for 'SD_expression':
  Mean |Δseverity|: 1.3710
  95% CI: [1.1613, 1.5968]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (200, 10)
[DEBUG] First 3 embedding indices: ['CoV-41.2-SS1', 'CoV-206.1-Su', 'CoV-103.2-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=200, meta_only=341, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.2-Wilk', 'CoV-104.1-Su', 'CoV-105.1-Su', 'CoV-105.2-Su', 'CoV-106.1-Su']
[DEBUG] After alignment: meta_df=(200, 6), embedding_df=(200, 10)
[DEBUG] Dropped rows -> meta: 341, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.35974952 0.16734234]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (11): ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 200 samples

Merging data...
  Merged data: 200 samples retained

Performing ANOVA...
  Analyzing 200 samples with complete data
  Number of batches: 11
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 1.9829e-05 (η² = 0.399)
  Severity Effect: p = 1.0000e+00 (η² = -0.000)
  Interaction: p = 1.2863e-21 (η² = 0.676)
  Overall Assessment: POOR
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 200
Batches: 11 -> ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 1.5184 ± 0.9420
iLISI_norm: 0.1380
ASW-batch: 0.4007

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 200
Samples with valid severity: 200
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): -0.0249
Normalized Mutual Info (NMI): 0.0712
Average Cluster Purity: 0.6943

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 200 samples

Merging data...
  Merged data: 200 samples retained

Calculating Spearman correlation...
  Analyzing 200 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.5742 (p = 6.1435e-19)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 129 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq     df          F        PR(>F)
C(Q('sev.level'))  1.272176    3.0  30.206615  9.348194e-15
Residual           1.754825  125.0        NaN           NaN
SciPy F-test: F=30.2066, p=9.348e-15
Effect sizes: eta²=0.4203, ω²=0.4045

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        129
SS2        23
SS1        13
Wilk        8
Lee         7
Zhu         6
Yu          4
Mudd        3
Aruna       3
Wen         2
Silvin      2
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 11, n_non_anchor = 71

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 71
Anchor samples: 129
Pool samples: 71
k_neighbors: 1

Results for 'SD_expression':
  Mean |Δseverity|: 1.3178
  95% CI: [1.1705, 1.4729]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (249, 10)
[DEBUG] First 3 embedding indices: ['CoV-140.2-Su', 'CoV-204.1-Su', 'CoV-182.2-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=249, meta_only=292, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.1-Wilk', 'CoV-1.2-Wilk', 'CoV-118.1-Su', 'CoV-121.1-Su', 'CoV-122.1-Su']
[DEBUG] After alignment: meta_df=(249, 6), embedding_df=(249, 10)
[DEBUG] Dropped rows -> meta: 292, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.37218266 0.17266982]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (1): ['Su']
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 249 samples

Merging data...
  Merged data: 249 samples retained

Performing ANOVA...
  Analyzing 249 samples with complete data
  Number of batches: 1
  Number of severity levels: 4
  Only ONE batch detected → falling back to ONE-WAY ANOVA on severity_level.
  ANOVA table index: ['C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: (no batch factor — single-batch dataset)
  Severity Effect: p = 7.3769e-32 (η² = 0.453)
  Interaction: (not applicable for one-way severity model)
  Overall Assessment: EXCELLENT
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 249
Samples with valid severity: 249
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0025
Normalized Mutual Info (NMI): 0.0237
Average Cluster Purity: 0.8526

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 249 samples

Merging data...
  Merged data: 249 samples retained

Calculating Spearman correlation...
  Analyzing 249 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.6807 (p = 3.0549e-35)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 249 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq     df          F        PR(>F)
C(Q('sev.level'))  5.047078    3.0  67.529874  7.376885e-32
Residual           6.103640  245.0        NaN           NaN
SciPy F-test: F=67.5299, p=7.377e-32
Effect sizes: eta²=0.4526, ω²=0.4449

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su    249
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 1, n_non_anchor = 0

[INFO] Only anchor batch present in data. Skipping nearest-neighbor severity gap analysis.
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (405, 10)
[DEBUG] First 3 embedding indices: ['CoV-192.2-Su', 'CoV-71.1-SS2', 'CoV-23.2-Lee']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=405, meta_only=136, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-118.1-Su', 'CoV-121.1-Su', 'CoV-122.1-Su', 'CoV-124.1-Su', 'CoV-131-Su']
[DEBUG] After alignment: meta_df=(405, 6), embedding_df=(405, 10)
[DEBUG] Dropped rows -> meta: 136, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.30250279 0.27721044]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (12): ['Aruna', 'Guo', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 405 samples

Merging data...
  Merged data: 405 samples retained

Performing ANOVA...
  Analyzing 405 samples with complete data
  Number of batches: 12
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 3.9420e-01 (η² = 0.027)
  Severity Effect: p = 1.0000e+00 (η² = -0.433)
  Interaction: p = 3.3886e-03 (η² = 0.162)
  Overall Assessment: INEFFECTIVE
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 405
Batches: 12 -> ['Aruna', 'Guo', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.5830 ± 1.2268
iLISI_norm: 0.2153
ASW-batch: 0.6017

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 405
Samples with valid severity: 405
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): -0.0002
Normalized Mutual Info (NMI): 0.0135
Average Cluster Purity: 0.8458

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 405 samples

Merging data...
  Merged data: 405 samples retained

Calculating Spearman correlation...
  Analyzing 405 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.5665 (p = 9.3154e-36)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 249 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq     df          F        PR(>F)
C(Q('sev.level'))  3.924119    3.0  51.072073  1.125904e-25
Residual           6.274853  245.0        NaN           NaN
SciPy F-test: F=51.0721, p=1.126e-25
Effect sizes: eta²=0.3848, ω²=0.3763

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        249
SS2        56
SS1        25
Lee        14
Zhu        14
Wilk       13
Aruna      12
Yu          9
Wen         5
Mudd        4
Guo         2
Silvin      2
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 12, n_non_anchor = 156

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 156
Anchor samples: 249
Pool samples: 156
k_neighbors: 1

Results for 'SD_expression':
  Mean |Δseverity|: 1.0040
  95% CI: [0.9036, 1.1124]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_expression/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (25, 5)
[DEBUG] First 3 embedding indices: ['CoV-218-Mudd', 'CoV-45-SS1', 'CoV-181.1-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=25, meta_only=516, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.1-Wilk', 'CoV-1.2-Wilk', 'CoV-100.1-Su', 'CoV-100.2-Su', 'CoV-101.1-Su']
[DEBUG] After alignment: meta_df=(25, 6), embedding_df=(25, 5)
[DEBUG] Dropped rows -> meta: 516, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.67313269 0.22811925]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (6): ['Mudd', 'SS1', 'SS2', 'Su', 'Wilk', 'Zhu']
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 25 samples

Merging data...
  Merged data: 25 samples retained

Performing ANOVA...
  Analyzing 25 samples with complete data
  Number of batches: 6
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 5.0775e-01 (η² = 0.133)
  Severity Effect: p = 7.0009e-01 (η² = 0.030)
  Interaction: p = 4.3911e-01 (η² = 0.512)
  Overall Assessment: INEFFECTIVE
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 25
Batches: 6 -> ['Mudd', 'SS1', 'SS2', 'Su', 'Wilk', 'Zhu']

iLISI (mean ± sd): 2.3034 ± 0.3228
iLISI_norm: 0.3839
ASW-batch: 0.7012

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 25
Samples with valid severity: 25
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0233
Normalized Mutual Info (NMI): 0.1336
Average Cluster Purity: 0.4429

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 25 samples

Merging data...
  Merged data: 25 samples retained

Calculating Spearman correlation...
  Analyzing 25 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = -0.4070 (p = 4.3492e-02)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 16 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq    df         F    PR(>F)
C(Q('sev.level'))  0.443910   3.0  1.908911  0.182009
Residual           0.930185  12.0       NaN       NaN
SciPy F-test: F=1.9089, p=0.182
Effect sizes: eta²=0.3231, ω²=0.1456

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su      16
SS1      4
Mudd     2
Wilk     1
SS2      1
Zhu      1
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 6, n_non_anchor = 9

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 9
Anchor samples: 16
Pool samples: 9
k_neighbors: 1

Results for 'SD_proportion':
  Mean |Δseverity|: 1.0625
  95% CI: [0.6875, 1.5000]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (50, 5)
[DEBUG] First 3 embedding indices: ['CoV-64.3-SS2', 'CoV-91.1-Su', 'HD-13-Lee']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=50, meta_only=491, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.1-Wilk', 'CoV-100.1-Su', 'CoV-100.2-Su', 'CoV-101.1-Su', 'CoV-101.2-Su']
[DEBUG] After alignment: meta_df=(50, 6), embedding_df=(50, 5)
[DEBUG] Dropped rows -> meta: 491, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.67122042 0.14912772]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (10): ['Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 50 samples

Merging data...
  Merged data: 50 samples retained

Performing ANOVA...
  Analyzing 50 samples with complete data
  Number of batches: 10
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 9.3722e-01 (η² = 0.017)
  Severity Effect: p = 1.0000e+00 (η² = -0.000)
  Interaction: p = 1.5711e-01 (η² = 0.559)
  Overall Assessment: INEFFECTIVE
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 50
Batches: 10 -> ['Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.4673 ± 0.6431
iLISI_norm: 0.2467
ASW-batch: 0.7218

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 50
Samples with valid severity: 50
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0133
Normalized Mutual Info (NMI): 0.1324
Average Cluster Purity: 0.8533

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 50 samples

Merging data...
  Merged data: 50 samples retained

Calculating Spearman correlation...
  Analyzing 50 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.3943 (p = 4.6041e-03)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 29 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq    df         F    PR(>F)
C(Q('sev.level'))  0.667371   3.0  4.376961  0.013134
Residual           1.270613  25.0       NaN       NaN
SciPy F-test: F=4.3770, p=0.01313
Effect sizes: eta²=0.3444, ω²=0.2589

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        29
SS2        6
SS1        5
Zhu        3
Wen        2
Wilk       1
Lee        1
Yu         1
Silvin     1
Mudd       1
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 10, n_non_anchor = 21

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 21
Anchor samples: 29
Pool samples: 21
k_neighbors: 1

Results for 'SD_proportion':
  Mean |Δseverity|: 0.9655
  95% CI: [0.6552, 1.2759]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_50_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (100, 5)
[DEBUG] First 3 embedding indices: ['CoV-61-SS2', 'CoV-152.1-Su', 'CoV-206.2-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=100, meta_only=441, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.2-Wilk', 'CoV-100.2-Su', 'CoV-101.1-Su', 'CoV-101.2-Su', 'CoV-102.1-Su']
[DEBUG] After alignment: meta_df=(100, 6), embedding_df=(100, 5)
[DEBUG] Dropped rows -> meta: 441, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.71713264 0.18602173]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (11): ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 100 samples

Merging data...
  Merged data: 100 samples retained

Performing ANOVA...
  Analyzing 100 samples with complete data
  Number of batches: 11
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 4.6614e-01 (η² = 0.066)
  Severity Effect: p = 1.0000e+00 (η² = 0.000)
  Interaction: p = 3.1044e-01 (η² = 0.317)
  Overall Assessment: INEFFECTIVE
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 100
Batches: 11 -> ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.4777 ± 0.8559
iLISI_norm: 0.2252
ASW-batch: 0.7288

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 100
Samples with valid severity: 100
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0087
Normalized Mutual Info (NMI): 0.0545
Average Cluster Purity: 0.5995

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 100 samples

Merging data...
  Merged data: 100 samples retained

Calculating Spearman correlation...
  Analyzing 100 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.4255 (p = 1.0164e-05)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 62 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq    df         F    PR(>F)
C(Q('sev.level'))  0.909589   3.0  6.589164  0.000658
Residual           2.668835  58.0       NaN       NaN
SciPy F-test: F=6.5892, p=0.0006576
Effect sizes: eta²=0.2542, ω²=0.2129

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        62
SS2       13
Lee        4
Zhu        4
Aruna      4
SS1        4
Wilk       3
Wen        2
Mudd       2
Yu         1
Silvin     1
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 11, n_non_anchor = 38

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 38
Anchor samples: 62
Pool samples: 38
k_neighbors: 1

Results for 'SD_proportion':
  Mean |Δseverity|: 0.9194
  95% CI: [0.7097, 1.1290]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_100_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (200, 5)
[DEBUG] First 3 embedding indices: ['CoV-169.2-Su', 'CoV-91.1-Su', 'CoV-165.1-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=200, meta_only=341, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.2-Wilk', 'CoV-104.1-Su', 'CoV-105.1-Su', 'CoV-105.2-Su', 'CoV-106.1-Su']
[DEBUG] After alignment: meta_df=(200, 6), embedding_df=(200, 5)
[DEBUG] Dropped rows -> meta: 341, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.6593224  0.23568441]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (11): ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 200 samples

Merging data...
  Merged data: 200 samples retained

Performing ANOVA...
  Analyzing 200 samples with complete data
  Number of batches: 11
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 9.5663e-05 (η² = 0.359)
  Severity Effect: p = 1.0000e+00 (η² = -0.000)
  Interaction: p = 6.6623e-16 (η² = 0.600)
  Overall Assessment: POOR
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 200
Batches: 11 -> ['Aruna', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.2431 ± 1.2797
iLISI_norm: 0.2039
ASW-batch: 0.6228

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 200
Samples with valid severity: 200
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0100
Normalized Mutual Info (NMI): 0.0351
Average Cluster Purity: 0.6802

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 200 samples

Merging data...
  Merged data: 200 samples retained

Calculating Spearman correlation...
  Analyzing 200 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.4888 (p = 2.0913e-13)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 129 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq     df          F        PR(>F)
C(Q('sev.level'))  2.154056    3.0  29.384962  1.903064e-14
Residual           3.054362  125.0        NaN           NaN
SciPy F-test: F=29.3850, p=1.903e-14
Effect sizes: eta²=0.4136, ω²=0.3976

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        129
SS2        23
SS1        13
Wilk        8
Lee         7
Zhu         6
Yu          4
Mudd        3
Aruna       3
Wen         2
Silvin      2
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 11, n_non_anchor = 71

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 71
Anchor samples: 129
Pool samples: 71
k_neighbors: 1

Results for 'SD_proportion':
  Mean |Δseverity|: 1.1550
  95% CI: [1.0000, 1.3101]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_200_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (249, 5)
[DEBUG] First 3 embedding indices: ['CoV-117.2-Su', 'CoV-103.2-Su', 'CoV-182.1-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=249, meta_only=292, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-1.1-Wilk', 'CoV-1.2-Wilk', 'CoV-118.1-Su', 'CoV-121.1-Su', 'CoV-122.1-Su']
[DEBUG] After alignment: meta_df=(249, 6), embedding_df=(249, 5)
[DEBUG] Dropped rows -> meta: 292, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.66444    0.26917648]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (1): ['Su']
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 249 samples

Merging data...
  Merged data: 249 samples retained

Performing ANOVA...
  Analyzing 249 samples with complete data
  Number of batches: 1
  Number of severity levels: 4
  Only ONE batch detected → falling back to ONE-WAY ANOVA on severity_level.
  ANOVA table index: ['C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: (no batch factor — single-batch dataset)
  Severity Effect: p = 2.2044e-21 (η² = 0.333)
  Interaction: (not applicable for one-way severity model)
  Overall Assessment: EXCELLENT
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 249
Samples with valid severity: 249
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0235
Normalized Mutual Info (NMI): 0.0831
Average Cluster Purity: 0.8320

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 249 samples

Merging data...
  Merged data: 249 samples retained

Calculating Spearman correlation...
  Analyzing 249 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.5633 (p = 3.0122e-22)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 249 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq     df          F        PR(>F)
C(Q('sev.level'))  3.431446    3.0  40.713386  2.204377e-21
Residual           6.883111  245.0        NaN           NaN
SciPy F-test: F=40.7134, p=2.204e-21
Effect sizes: eta²=0.3327, ω²=0.3236

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_279_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su    249
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 1, n_non_anchor = 0

[INFO] Only anchor batch present in data. Skipping nearest-neighbor severity gap analysis.
============================================================

[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (405, 5)
[DEBUG] First 3 embedding indices: ['CoV-74.1-SS2', 'CoV-63.3-SS2', 'CoV-144.2-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=405, meta_only=136, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-118.1-Su', 'CoV-121.1-Su', 'CoV-122.1-Su', 'CoV-124.1-Su', 'CoV-131-Su']
[DEBUG] After alignment: meta_df=(405, 6), embedding_df=(405, 5)
[DEBUG] Dropped rows -> meta: 136, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.57962533 0.24001267]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (12): ['Aruna', 'Guo', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 405 samples

Merging data...
  Merged data: 405 samples retained

Performing ANOVA...
  Analyzing 405 samples with complete data
  Number of batches: 12
  Number of severity levels: 4
  Multiple batches detected → running TWO-WAY ANOVA (batch + severity + interaction).
  ANOVA table index: ['C(batch)', 'C(severity_level)', 'C(batch):C(severity_level)', 'Residual']
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 1.5210e-03 (η² = 0.162)
  Severity Effect: p = 6.6170e-03 (η² = 0.039)
  Interaction: p = 2.3280e-04 (η² = 0.192)
  Overall Assessment: MODERATE
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 405
Batches: 12 -> ['Aruna', 'Guo', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 2.1986 ± 1.3675
iLISI_norm: 0.1832
ASW-batch: 0.6063

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 405
Samples with valid severity: 405
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): 0.0011
Normalized Mutual Info (NMI): 0.0196
Average Cluster Purity: 0.8454

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 405 samples

Merging data...
  Merged data: 405 samples retained

Calculating Spearman correlation...
  Analyzing 405 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = -0.4754 (p = 3.1185e-24)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/trajectory_analysis/Spearman_Correlation

============================================================
DEBUG: ANOVA Analysis
============================================================
pseudotime_col = pseudotime
make_plots = True
Anchor batch 'Su' has 249 samples
Unique severity levels: [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]

ANOVA table:
                     sum_sq     df         F        PR(>F)
C(Q('sev.level'))  3.996777    3.0  45.17506  2.835897e-23
Residual           7.225301  245.0       NaN           NaN
SciPy F-test: F=45.1751, p=2.836e-23
Effect sizes: eta²=0.3562, ω²=0.3474

>>> Generating ANOVA plot with effect size...
>>> ANOVA plot saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/su_anova_box_effectsize.png

[DEBUG] Batch value counts:
batch
Su        249
SS2        56
SS1        25
Lee        14
Zhu        14
Wilk       13
Aruna      12
Yu          9
Wen         5
Mudd        4
Guo         2
Silvin      2
Name: count, dtype: int64
[DEBUG] anchor_batch = Su
[DEBUG] n_batches = 12, n_non_anchor = 156

============================================================
DEBUG: Nearest Neighbor Severity Gap Analysis
============================================================
[DEBUG] neighbor pool size after filters = 156
Anchor samples: 249
Pool samples: 156
k_neighbors: 1

Results for 'SD_proportion':
  Mean |Δseverity|: 0.9920
  95% CI: [0.8916, 1.0964]

Summary CSV saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_summary.csv
Histogram saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/benchmark_results_SD_proportion/pseudotime_embeddings_custom/nn_severity_gap_hist.png
============================================================


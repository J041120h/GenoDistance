======================================
 Job ID:            17711946
 Job Name:          test
 Partition:         gpu
 Node List:         compute-170
 CPUs per Task:     16
 Memory Alloc:      819200
 GPU Requested:     1
 Start Time:        Sat Jun 21 03:52:20 PM EDT 2025
======================================
Checking GPU status...
Sat Jun 21 15:52:23 2025       
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 555.42.06              Driver Version: 555.42.06      CUDA Version: 12.5     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA H100 NVL                Off |   00000000:D1:00.0 Off |                    0 |
| N/A   43C    P0             91W /  400W |       1MiB /  95830MiB |      3%      Default |
|                                         |                        |             Disabled |
+-----------------------------------------+------------------------+----------------------+
                                                                                         
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
Starting main.py...
Start of Process

Resuming process from previous progress:
{
    "preprocessing": true,
    "cell_type_cluster": true,
    "sample_distance_calculation": true,
    "DimensionalityReduction": true,
    "trajectory_analysis": true,
    "visualize_data": true,
    "initialization": false
}
Linux system detected.


Enabling managed memory for RMM...


[cell_types_atac] No cell type annotation found. Performing clustering at resolution 0.7.
[cell_types_atac] Building neighborhood graph...
[cell_types_atac] No target clusters specified. Using standard Leiden clustering (resolution=0.7)...
[cell_types_atac] Found 24 clusters after Leiden clustering.
[cell_types_atac] Finished assigning cell types.
[standardize] Converted categorical to string format
[standardize] Final cell types (n=24): ['1', '10', '11', '12', '13', '14', '15', '16', '17', '18', '19', '2', '20', '21', '22', '23', '24', '3', '4', '5', '6', '7', '8', '9']
[cell_types_atac] Total runtime: 25.49 seconds
Processing 24 cell types across 24 samples
Creating layer for 1
Creating layer for 10
Creating layer for 11
Creating layer for 12
Creating layer for 13
Creating layer for 14
Creating layer for 15
Creating layer for 16
Creating layer for 17
Creating layer for 18
Creating layer for 19
Creating layer for 2
Creating layer for 20
Creating layer for 21
Creating layer for 22
Creating layer for 23
Creating layer for 24
Creating layer for 3
Creating layer for 4
Creating layer for 5
Creating layer for 6
Creating layer for 7
Creating layer for 8
Creating layer for 9

Processing cell type: 1
Processing 24 cells × 230275 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.450
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 10
Processing 24 cells × 230219 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.460
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 11
Processing 24 cells × 229822 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.735
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 12
Processing 24 cells × 230129 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.721
  Selecting top 40000 HVGs
  Selected 40001 HVGs

Processing cell type: 13
Processing 24 cells × 229114 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.624
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 14
Processing 24 cells × 230057 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.800
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 15
Processing 24 cells × 216351 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.687
  Selecting top 40000 HVGs
  Selected 40373 HVGs

Processing cell type: 16
Processing 24 cells × 230016 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.676
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 17
Processing 24 cells × 204559 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.838
  Selecting top 40000 HVGs
  Selected 40192 HVGs

Processing cell type: 18
Processing 24 cells × 227895 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.871
  Selecting top 40000 HVGs
  Selected 40019 HVGs

Processing cell type: 19
Processing 24 cells × 230262 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.729
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 2
Processing 24 cells × 230314 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.519
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 20
Processing 24 cells × 212724 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.731
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 21
Processing 24 cells × 229844 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.917
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 22
Processing 24 cells × 224331 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.908
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 23
Processing 24 cells × 226951 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.957
  Selecting top 40000 HVGs
  Selected 40770 HVGs

Processing cell type: 24
Processing 24 cells × 220640 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.947
  Selecting top 40000 HVGs
  Selected 40356 HVGs

Processing cell type: 3
Processing 24 cells × 229872 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.712
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 4
Processing 24 cells × 229810 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.588
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 5
Processing 24 cells × 229836 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.530
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 6
Processing 24 cells × 230320 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.692
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 7
Processing 24 cells × 230293 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.691
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Processing cell type: 8
Processing 24 cells × 227544 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.916
  Selecting top 40000 HVGs
  Selected 40124 HVGs

Processing cell type: 9
Processing 24 cells × 229843 peaks
Input matrix is dense
Converting to sparse matrix...
Computing TF...
Computing IDF...
Computing TF-IDF...
Processed 24/24 cells
Output matrix sparsity: 0.862
  Selecting top 40000 HVGs
  Selected 40000 HVGs

Concatenating all cell type HVGs into single AnnData
Applying final HVG selection on 961835 concatenated genes
Final HVG selection: 40000 genes

Creating final HVG expression matrix

Total runtime: 40.17 seconds
Final HVG matrix shape: (24, 24)
Final AnnData shape: (24, 40000)
[process_anndata_with_pca] Starting dimension reduction computation...
[process_anndata_with_pca] Results will be stored under unified keys:
  - X_DR_expression: for expression data
  - X_DR_proportion: for proportion data
[process_anndata_with_pca] ATAC mode: Will use LSI for expression data
[process_anndata_with_pca] ✓ Created output directories:
  - count_output_dir: /dcl01/hongkai/data/data/hjiang/result/ATAC/harmony
  - pseudobulk_output_dir: /dcl01/hongkai/data/data/hjiang/result/ATAC/pseudobulk
[process_anndata_with_pca] Using n_expression_pcs=23, n_proportion_pcs=24
[process_anndata_with_pca] Data dimensions: expression=(24, 40000), proportion=(24, 24)
[DimRed] Computing LSI for ATAC data with 23 components on (24, 40000) data
[LSI] Computing LSI with 23 components on (24, 40000) data
[run_lsi_expression] Scanpy LSI failed: lsi
[run_lsi_expression] Attempting manual LSI with TF-IDF
[run_lsi_expression] Original shape: (24, 40000)
[run_lsi_expression] TF-IDF matrix stats: shape=(24, 40000), min=-0.021274, max=0.063202, mean=0.001312
[run_lsi_expression] Manual LSI computation successful. Shape: (24, 23)
[run_lsi_expression] LSI result stats: min=-0.576873, max=0.737825
[Storage] Stored X_lsi_expression_method in both adata and pseudobulk_anndata (shape: (24, 23))
[Storage] Stored X_DR_expression in both adata and pseudobulk_anndata (shape: (24, 23))
[DimRed] Successfully used LSI for ATAC dimension reduction
[DimRed] Completed - results stored as X_DR_expression in both adata and pseudobulk_anndata
[process_anndata_with_pca] ✓ Expression dimension reduction completed successfully
[run_pca_proportion] PCA on cell proportions completed.
Stored results as X_DR_proportion in both adata and pseudobulk_anndata with shape: (24, 24)
[process_anndata_with_pca] ✓ Proportion dimension reduction completed successfully
[process_anndata_with_pca] Preparing to save results...
[process_anndata_with_pca] Target file paths:
  - adata: /dcl01/hongkai/data/data/hjiang/result/ATAC/harmony/adata_sample.h5ad
  - pseudobulk_anndata: /dcl01/hongkai/data/data/hjiang/result/ATAC/pseudobulk/pseudobulk_sample.h5ad
[Save] Saving adata to: /dcl01/hongkai/data/data/hjiang/result/ATAC/harmony/adata_sample.h5ad
[Save] ✓ Successfully saved adata (1563.8 MB)
[Save] Saving pseudobulk_anndata to: /dcl01/hongkai/data/data/hjiang/result/ATAC/pseudobulk/pseudobulk_sample.h5ad
[Save] ✓ Successfully saved pseudobulk_anndata (3.3 MB)
[process_anndata_with_pca] ✓ All files saved successfully

[process_anndata_with_pca] === SUMMARY ===
Total runtime: 120.14 seconds
Expression dimension reduction: ✓ SUCCESS
Proportion dimension reduction: ✓ SUCCESS
Results available under unified keys:
  - X_DR_expression in both adata.uns and pseudobulk_anndata.uns
  - X_DR_proportion in both adata.uns and pseudobulk_anndata.uns
File saving: ✓ ATTEMPTED
Processing X_DR_proportion...

The CCA score for X_DR_proportion is 0.6649

Saved CCA plot to: /dcl01/hongkai/data/data/hjiang/result/CCA/pca_2d_cca_proportion.pdf
Processing X_DR_expression...

The CCA score for X_DR_expression is 0.2728

Saved CCA plot to: /dcl01/hongkai/data/data/hjiang/result/CCA/pca_2d_cca_expression.pdf
CCA analysis completed.

[CCA] Total runtime: 0.51 seconds

P-value for observed correlation 0.27284133416752143: 0.447
[CCA p-test] Runtime: 0.88 seconds
P-value for observed correlation 0.6648649148841654: 0.005
[CCA p-test] Runtime: 0.88 seconds
End of Process

Finished main.py.
End Time: Sat Jun 21 03:56:59 PM EDT 2025

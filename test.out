[DEBUG] Metadata loaded: shape=(541, 7), columns=['sample', 'study', 'age', 'sex', 'severity', 'batch', 'sev.level']
[DEBUG] Embedding matrix shape: (405, 10)
[DEBUG] First 3 embedding indices: ['CoV-138.1-Su', 'CoV-173.2-Su', 'CoV-83.2-Su']
[DEBUG] Setting meta_df index to 'sample'
[DEBUG] Overlap report: common=405, meta_only=136, embed_only=0
[DEBUG] Example meta_only IDs: ['CoV-118.1-Su', 'CoV-121.1-Su', 'CoV-122.1-Su', 'CoV-124.1-Su', 'CoV-131-Su']
[DEBUG] After alignment: meta_df=(405, 6), embedding_df=(405, 10)
[DEBUG] Dropped rows -> meta: 136, embed: 0
[DEBUG] Running PCA on aligned embedding_df...
[DEBUG] PCA done. Explained variance ratio: [0.34822364 0.22258171]
[DEBUG] Creating figure...
[DEBUG] Plotting sev.level panel...
[DEBUG] sev.level raw range: min=1, max=4
[DEBUG] sev.level normalized range: 0.000–1.000
[DEBUG] Plotting batch panel...
[DEBUG] Unique batches (12): ['Aruna', 'Guo', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk']...
[DEBUG] Saving figure to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/embedding_visualization/embedding_overview.png
[DEBUG] Saving PCA coordinates to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/embedding_visualization/pca_coordinates.csv
[DEBUG] Visualization completed successfully.

==================================================
STARTING TWO-WAY ANOVA TRAJECTORY ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 405 samples

Merging data...
  Merged data: 405 samples retained

Performing Two-way ANOVA...
  Analyzing 405 samples with complete data
  Number of batches: 12
  Number of severity levels: 4
  ANOVA table columns: ['sum_sq', 'df', 'F', 'PR(>F)']

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/trajectory_anova/ANOVA/twoway_anova_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/trajectory_anova/ANOVA/twoway_anova_summary.txt

==================================================
KEY RESULTS:
  Batch Effect: p = 4.4353e-09 (η² = 0.372)
  Severity Effect: p = 1.0000e+00 (η² = -0.008)
  Interaction: p = 2.2637e-08 (η² = 0.274)
  Overall Assessment: POOR
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/trajectory_anova/ANOVA
Batch-removal Evaluation Summary
================================
Samples: 405
Batches: 12 -> ['Aruna', 'Guo', 'Lee', 'Mudd', 'SS1', 'SS2', 'Silvin', 'Su', 'Wen', 'Wilk', 'Yu', 'Zhu']

iLISI (mean ± sd): 1.5019 ± 0.8309
iLISI_norm: 0.1252
ASW-batch: 0.4009

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/batch_removal/Batch_Removal_Evaluation
============================================================
ARI-based Clustering Evaluation Summary
============================================================
Data mode: embedding
Total samples: 405
Samples with valid severity: 405
Unique severity levels: 4 -> [np.int64(1), np.int64(2), np.int64(3), np.int64(4)]
Number of clusters used: 4
K neighbors for KNN: 20

METRICS:
------------------------------
Adjusted Rand Index (ARI): -0.0015
Normalized Mutual Info (NMI): 0.0124
Average Cluster Purity: 0.8451

INTERPRETATION:
------------------------------
VERY POOR: Almost no agreement between clusters and severity levels

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/ari_clustering/ARI_Clustering_Evaluation
============================================================

==================================================
STARTING TRAJECTORY CORRELATION ANALYSIS
==================================================
Loading data files...
  Loaded metadata: 541 samples
  Loaded pseudotime: 405 samples

Merging data...
  Merged data: 405 samples retained

Calculating Spearman correlation...
  Analyzing 405 samples with complete data

Creating visualizations...
  Saved plots to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_plots.png

Generating summary report...
  Saved summary report to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/trajectory_analysis/Spearman_Correlation/trajectory_correlation_summary.txt

==================================================
KEY RESULTS:
  Spearman ρ = 0.4251 (p = 3.3368e-19)
  Assessment: MODERATE positive correlation
  Statistical significance: highly significant (p < 0.001)
==================================================

✓ Analysis complete! Check the output directory for results.
  Output directory: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_400_sample/rna/benchmark_results_expression/trajectory_analysis/Spearman_Correlation

Linux system detected with GPU enabled.
Resuming process from previous progress:
{
    "rna": {
        "preprocessing": false,
        "cell_type_cluster": false,
        "dimensionality_reduction": false,
        "sample_distance_calculation": false,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "atac": {
        "preprocessing": false,
        "cell_type_cluster": false,
        "dimensionality_reduction": false,
        "sample_distance_calculation": false,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "multiomics": {
        "glue_integration": false,
        "glue_preprocessing": false,
        "glue_training": false,
        "glue_gene_activity": false,
        "glue_cell_types": false,
        "glue_visualization": false,
        "integration_preprocessing": false,
        "dimensionality_reduction": false,
        "embedding_visualization": false,
        "optimal_resolution": false
    },
    "system_info": {
        "platform": "Linux",
        "python_version": "3.10.13 | packaged by conda-forge | (main, Dec 23 2023, 15:36:39) [GCC 12.3.0]",
        "use_gpu": true,
        "linux_system": true
    }
}

============================================================
RUNNING MULTIOMICS PIPELINE
============================================================
Starting multi-modal pipeline with output directory: /dcs07/hongkai/data/harry/result/multiomics
Initial status flags: {'glue_integration': False, 'glue_preprocessing': False, 'glue_training': False, 'glue_gene_activity': False, 'glue_cell_types': False, 'glue_visualization': False, 'integration_preprocessing': False, 'dimensionality_reduction': False, 'embedding_visualization': False, 'optimal_resolution': False}
Step 1: Running GLUE integration...
  Sub-steps: Preprocessing=False, Training=False, Gene Activity=False, Cell Types=True, Visualization=True
Assigning cell types...
 Using Linux Cell Type Assignment for cell type assignment...
[cell_types] Starting cell type assignment (recursion depth: 0)...
[cell_types] Target clusters: 10
[cell_types] Data shape: (861190, 36601)
[cell_types] Progress: Moving data to GPU...
[cell_types] Progress: Data successfully moved to GPU
[cell_types] No cell type annotation found. Performing clustering.
[cell_types] Progress: Starting de novo clustering...
[cell_types] Building neighborhood graph...
[cell_types] Progress: Computing neighbors...
[cell_types] Progress: Neighborhood graph completed
[cell_types] Target: 10 clusters. Trying resolution: 0.5
[cell_types] Progress: Running Leiden clustering...
[cell_types] Progress: Leiden clustering completed, processing results...
[cell_types] Leiden clustering produced 24 clusters.
[cell_types] Progress: Evaluating clustering result against target...
[cell_types] Got 24 clusters (>= target). Recursing with existing_cell_types=True...
[cell_types] Progress: Initiating recursive aggregation...
  [cell_types] Starting cell type assignment (recursion depth: 1)...
  [cell_types] Target clusters: 10
  [cell_types] Data shape: (861190, 36601)
  [cell_types] Progress: Processing existing cell type annotations...
  [cell_types] Current number of cell types: 24
  [cell_types] Aggregating 24 cell types into 10 clusters using dendrogram.
  [cell_types] Using dimension reduction (X_glue) for dendrogram construction...
  [cell_types] Progress: Starting dendrogram clustering...
=== Preparing data for dendrogram (using X_glue) ===
Using all 50 components from X_glue
=== Computing centroids of cell types in X_glue space ===
Calculated centroids for 24 cell types.
Centroid shape: (24, 50)
=== Computing distance matrix between centroids using euclidean distance ===
=== Performing hierarchical clustering on X_glue centroids ===
Linkage method: average, Distance metric: euclidean
=== Aggregating cell types into 10 clusters ===
Successfully created 10 clusters

=== Cluster Composition ===
Cluster 1: 20
Cluster 10: 23
Cluster 2: 3
Cluster 3: 12
Cluster 4: 1, 10, 11, 13, 16, 17, 19, 21, 22, 24, 4, 6, 7, 8, 9
Cluster 5: 2
Cluster 6: 14
Cluster 7: 15
Cluster 8: 18
Cluster 9: 5

=== Cluster Quality Metrics ===
Cluster 4: Average within-cluster distance = 3.3026

Function execution time: 0.62 seconds
  [cell_types] Successfully aggregated to 10 cell types.
  [cell_types] Progress: Dendrogram clustering completed
[cell_types] Progress: Returned from recursive aggregation
[cell_types] Progress: Starting final processing...
[cell_types] Finished assigning cell types.
[cell_types] Converting GPU arrays to CPU...
[cell_types] Progress: Starting GPU to CPU conversion...
[cell_types] Progress: Basic GPU to CPU conversion completed
[cell_types] Progress: Ensuring complete CPU conversion...
[cell_types] Progress: Complete CPU conversion finished
[cell_types] Progress: Saving to defined path /dcs07/hongkai/data/harry/result/multiomics/preprocess/atac_rna_integrated.h5ad...
[safe_h5ad_write] Preparing to save to: /dcs07/hongkai/data/harry/result/multiomics/preprocess/atac_rna_integrated.h5ad
[clean_obs_for_saving] Cleaning observation metadata for H5AD compatibility...
[clean_obs_for_saving] Cleaning completed successfully
[clean_obs_for_saving] 5 categorical columns processed
[safe_h5ad_write] Writing H5AD file...
[safe_h5ad_write] Successfully saved to: /dcs07/hongkai/data/harry/result/multiomics/preprocess/atac_rna_integrated.h5ad
[cell_types] Progress: File saved successfully
[cell_types] Total runtime: 2014.90 seconds
[cell_types] Progress: Function execution completed successfully
Running visualization...
Loading integrated RNA-ATAC data...
Computing UMAP from scGLUE embeddings...
Generating visualizations for columns: ['modality', 'cell_type']
Error plotting modality: [Errno 2] No such file or directory: '/dcs07/hongkai/data/harry/result/multiomics/visualization/scglue_umap_modality.png'
Error plotting cell_type: [Errno 2] No such file or directory: '/dcs07/hongkai/data/harry/result/multiomics/visualization/scglue_umap_cell_type.png'

Creating modality-cell type distribution heatmap...

✗ Multiomics pipeline failed with error: [Errno 2] No such file or directory: '/dcs07/hongkai/data/harry/result/multiomics/visualization/scglue_modality_celltype_heatmap.png'

============================================================
PIPELINE EXECUTION SUMMARY
============================================================
Multiomics Pipeline: ⚠ PARTIAL
  - glue_integration: ✗
  - glue_preprocessing: ✗
  - glue_training: ✗
  - glue_gene_activity: ✗
  - glue_cell_types: ✗
  - glue_visualization: ✗
  - integration_preprocessing: ✗
  - dimensionality_reduction: ✗
  - embedding_visualization: ✗
  - optimal_resolution: ✗

Results saved to: /dcs07/hongkai/data/harry/result
Status file: /dcs07/hongkai/data/harry/result/sys_log/main_process_status.json

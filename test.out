Linux system detected with GPU enabled.
Resuming process from previous progress:
{
    "rna": {
        "preprocessing": true,
        "cell_type_cluster": true,
        "dimensionality_reduction": true,
        "sample_distance_calculation": true,
        "trajectory_analysis": true,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "atac": {
        "preprocessing": false,
        "cell_type_cluster": false,
        "dimensionality_reduction": false,
        "sample_distance_calculation": false,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "multiomics": {
        "glue_integration": false,
        "glue_preprocessing": false,
        "glue_training": false,
        "glue_gene_activity": false,
        "glue_cell_types": false,
        "glue_visualization": false,
        "integration_preprocessing": false,
        "dimensionality_reduction": false,
        "embedding_visualization": false,
        "optimal_resolution": false
    },
    "system_info": {
        "platform": "Linux",
        "python_version": "3.10.18 | packaged by conda-forge | (main, Jun  4 2025, 14:45:41) [GCC 13.3.0]",
        "use_gpu": true,
        "linux_system": true
    }
}

============================================================
RUNNING RNA PIPELINE
============================================================
Starting RNA wrapper function with provided parameters...
Starting cell type clustering at resolution: 1
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
[cell_types] No cell type annotation found. Performing clustering.
[cell_types] Building neighborhood graph...
[cell_types] No target clusters specified. Using standard Leiden clustering (resolution=1)...
[cell_types] Found 16 clusters after Leiden clustering.
[cell_types] Finished assigning cell types.
[cell_types] Computing UMAP...
[cell_types] Converting GPU arrays to CPU...
[cell_types] Generating UMAP visualizations...
[generate_umap_visualizations] Generating UMAP plots...
[generate_umap_visualizations] → Plotting UMAP colored by 'cell_type' (16 categories)
[generate_umap_visualizations] ✓ Saved: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/preprocess/umap_cell_type.png
[cell_types] Total runtime: 3.03 seconds
[safe_h5ad_write] Preparing to save to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/preprocess/adata_sample.h5ad
[clean_obs_for_saving] Cleaning observation metadata for H5AD compatibility...
[clean_obs_for_saving] Cleaning completed successfully
[clean_obs_for_saving] 11 categorical columns processed
[safe_h5ad_write] Writing H5AD file...
[safe_h5ad_write] Successfully saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/preprocess/adata_sample.h5ad
Starting dimensionality reduction...
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
Using PyTorch with GPU: NVIDIA L40S
Initial GPU memory: 0.00/0.00 GB allocated/reserved
Processing 16 cell types across 25 samples
Creating layer for 1
Creating layer for 10
Creating layer for 11
Creating layer for 12
Creating layer for 13
Creating layer for 14
Creating layer for 15
Creating layer for 16
Creating layer for 2
Creating layer for 3
Creating layer for 4
Creating layer for 5
Creating layer for 6
Creating layer for 7
Creating layer for 8
Creating layer for 9

Processing cell type: 1
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 10
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 11
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 12
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 13
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 14
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 15
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 16
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 2
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 3
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 4
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 5
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 6
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 7
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 8
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Processing cell type: 9
  Selecting top 2000 HVGs
  Selected 2000 HVGs

Concatenating all cell type HVGs into single AnnData
Applying final HVG selection on 32000 concatenated genes
Final HVG selection: 2000 genes

Creating final HVG expression matrix

Total runtime: 23.56 seconds
Final HVG matrix shape: (16, 25)
Final AnnData shape: (25, 2000)
[process_anndata_with_dimension_reduction] Starting dimension reduction computation...
[process_anndata_with_dimension_reduction] Results will be stored under unified keys:
  - X_DR_expression: for expression data
  - X_DR_proportion: for proportion data
[process_anndata_with_dimension_reduction] RNA mode: Will use PCA for expression data
[process_anndata_with_dimension_reduction] ✓ Created output directories:
  - count_output_dir: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/preprocess
  - pseudobulk_output_dir: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/pseudobulk
[process_anndata_with_dimension_reduction] Using n_expression_components=10, n_proportion_components=5
[process_anndata_with_dimension_reduction] Data dimensions: expression=(25, 2000), proportion=(25, 16)
[DimRed] Computing PCA for RNA data with 10 components on (25, 2000) data
[PCA] Success. Shape: (25, 10)
[Storage] Stored X_DR_expression in both adata and pseudobulk_anndata (shape: (25, 10))
[Storage] Stored X_pca_expression_method in both adata and pseudobulk_anndata (shape: (25, 10))
[PCA] Stored variance information in both objects
[DimRed] Completed - results stored as X_DR_expression in both adata and pseudobulk_anndata
[process_anndata_with_dimension_reduction] ✓ Expression dimension reduction completed successfully
[run_dimension_reduction_proportion] Computing PCA with 5 components...
[run_dimension_reduction_proportion] Completed using PCA. Shape: (25, 5)
[process_anndata_with_dimension_reduction] ✓ Proportion dimension reduction completed successfully
[process_anndata_with_dimension_reduction] Preparing to save results...
[process_anndata_with_dimension_reduction] Target file paths:
  - adata: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/preprocess/adata_sample.h5ad
  - pseudobulk_anndata: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/pseudobulk/pseudobulk_sample.h5ad
[Save] Saving adata to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/preprocess/adata_sample.h5ad
[Save] ✓ Successfully saved adata (207.0 MB)
[Save] Saving pseudobulk_anndata to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/pseudobulk/pseudobulk_sample.h5ad
[Save] ✓ Successfully saved pseudobulk_anndata (0.4 MB)
[process_anndata_with_dimension_reduction] ✓ All files saved successfully

[process_anndata_with_dimension_reduction] === SUMMARY ===
Total runtime: 16.41 seconds
Expression dimension reduction: ✓ SUCCESS
Proportion dimension reduction: ✓ SUCCESS
Results available under unified keys:
  - X_DR_expression in both adata.uns and pseudobulk_anndata.uns
  - X_DR_proportion in both adata.uns and pseudobulk_anndata.uns
File saving: ✓ ATTEMPTED

Running sample distance: cosine

[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
Computing cosine distance using dimension reduction results...
Data type: ATAC (affects DR method prioritization)
Available sample metadata columns: ['study', 'age', 'sex', 'severity', 'batch', 'sev.level', 'predicted_doublet']
Number of samples: 25
Computing sample distances using expression dimension reduction (X_DR_expression)...
Distance check results saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/expression_DR_distance/distance_check_results_expression_DR_cosine.txt
Score for expression_DR (cosine): 1.042914
Summary updated in /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/summary_sample.csv
Distance check completed for expression_DR: score = 1.042914
Sample distance heatmap saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/expression_DR_distance/sample_distance_expression_DR_heatmap.pdf
expression_DR-based distance matrix saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/expression_DR_distance
Computing sample distances using proportion dimension reduction (X_DR_proportion)...
Distance check results saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/proportion_DR_distance/distance_check_results_proportion_DR_cosine.txt
Score for proportion_DR (cosine): 1.070229
Summary updated in /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/summary_sample.csv
Distance check completed for proportion_DR: score = 1.070229
Sample distance heatmap saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/proportion_DR_distance/sample_distance_proportion_DR_heatmap.pdf
proportion_DR-based distance matrix saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/proportion_DR_distance
Sample distance computations completed for: expression_DR, proportion_DR
Distance statistics summary saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/cosine/distance_statistics_summary_cosine.csv

Running sample distance: correlation

[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
Computing correlation distance using dimension reduction results...
Data type: ATAC (affects DR method prioritization)
Available sample metadata columns: ['study', 'age', 'sex', 'severity', 'batch', 'sev.level', 'predicted_doublet']
Number of samples: 25
Computing sample distances using expression dimension reduction (X_DR_expression)...
Distance check results saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/expression_DR_distance/distance_check_results_expression_DR_correlation.txt
Score for expression_DR (correlation): 0.978756
Summary updated in /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/summary_sample.csv
Distance check completed for expression_DR: score = 0.978756
Sample distance heatmap saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/expression_DR_distance/sample_distance_expression_DR_heatmap.pdf
expression_DR-based distance matrix saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/expression_DR_distance
Computing sample distances using proportion dimension reduction (X_DR_proportion)...
Distance check results saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/proportion_DR_distance/distance_check_results_proportion_DR_correlation.txt
Score for proportion_DR (correlation): 1.081487
Summary updated in /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/summary_sample.csv
Distance check completed for proportion_DR: score = 1.081487
Sample distance heatmap saved to /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/proportion_DR_distance/sample_distance_proportion_DR_heatmap.pdf
proportion_DR-based distance matrix saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/proportion_DR_distance
Sample distance computations completed for: expression_DR, proportion_DR
Distance statistics summary saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance/correlation/distance_statistics_summary_correlation.csv
Sample distance calculation completed. Results saved in /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/Sample_distance
Starting trajectory analysis...
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42

Processing X_DR_proportion...
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
Warning: Only 5 components available, using all of them.
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
Auto-selecting best 2-PC combination from 5 components...
Testing 10 PC combinations...
PC1 + PC2: CCA score = 0.3500
PC1 + PC3: CCA score = 0.3528
PC1 + PC4: CCA score = 0.3362
PC1 + PC5: CCA score = 0.3341
PC2 + PC3: CCA score = 0.2967
PC2 + PC4: CCA score = 0.2768
PC2 + PC5: CCA score = 0.2742
PC3 + PC4: CCA score = 0.2803
PC3 + PC5: CCA score = 0.2777
PC4 + PC5: CCA score = 0.2563
Best combination: PC1 + PC3 with score 0.3528
Saved CCA plot to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/CCA/pca_10d_cca_proportion.pdf
Saved CCA contributions plot to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/CCA/pca_10d_cca_proportion_contributions.pdf

Processing X_DR_expression...
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42
Auto-selecting best 2-PC combination from 10 components...
Testing 45 PC combinations...
PC1 + PC2: CCA score = 0.0940
PC1 + PC3: CCA score = 0.0758
PC1 + PC4: CCA score = 0.1891
PC1 + PC5: CCA score = 0.5731
PC1 + PC6: CCA score = 0.0617
PC1 + PC7: CCA score = 0.2504
PC1 + PC8: CCA score = 0.1048
PC1 + PC9: CCA score = 0.2222
PC1 + PC10: CCA score = 0.0292
PC2 + PC3: CCA score = 0.1142
PC2 + PC4: CCA score = 0.2075
PC2 + PC5: CCA score = 0.5794
PC2 + PC6: CCA score = 0.1053
PC2 + PC7: CCA score = 0.2645
PC2 + PC8: CCA score = 0.1352
PC2 + PC9: CCA score = 0.2380
PC2 + PC10: CCA score = 0.0903
PC3 + PC4: CCA score = 0.1999
PC3 + PC5: CCA score = 0.5768
PC3 + PC6: CCA score = 0.0894
PC3 + PC7: CCA score = 0.2586
PC3 + PC8: CCA score = 0.1232
PC3 + PC9: CCA score = 0.2314
PC3 + PC10: CCA score = 0.0711
PC4 + PC5: CCA score = 0.6022
PC4 + PC6: CCA score = 0.1950
PC4 + PC7: CCA score = 0.3113
PC4 + PC8: CCA score = 0.2126
PC4 + PC9: CCA score = 0.2891
PC4 + PC10: CCA score = 0.1873
PC5 + PC6: CCA score = 0.5751
PC5 + PC7: CCA score = 0.6242
PC5 + PC8: CCA score = 0.5813
PC5 + PC9: CCA score = 0.6134
PC5 + PC10: CCA score = 0.5725
PC6 + PC7: CCA score = 0.2548
PC6 + PC8: CCA score = 0.1151
PC6 + PC9: CCA score = 0.2272
PC6 + PC10: CCA score = 0.0558
PC7 + PC8: CCA score = 0.2686
PC7 + PC9: CCA score = 0.3324
PC7 + PC10: CCA score = 0.2490
PC8 + PC9: CCA score = 0.2425
PC8 + PC10: CCA score = 0.1014
PC9 + PC10: CCA score = 0.2206
Best combination: PC5 + PC7 with score 0.6242
Saved CCA plot to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/CCA/pca_10d_cca_expression.pdf
Saved CCA contributions plot to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/CCA/pca_10d_cca_expression_contributions.pdf
Saved proportion pseudotime data to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/CCA/pseudotime_proportion.csv
Saved expression pseudotime data to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/rna/CCA/pseudotime_expression.csv

==================================================
CCA ANALYSIS SUMMARY
==================================================
X_DR_proportion: CCA score = 0.3528 (using PC1 + PC3)
X_DR_expression: CCA score = 0.6242 (using PC5 + PC7)

Total runtime: 0.65 seconds
==================================================
P-value for observed correlation 0.3527521392264637: 0.222
[CCA p-test] Runtime: 0.86 seconds
P-value for observed correlation 0.6241772915412251: 0.007
[CCA p-test] Runtime: 0.85 seconds
RNA analysis completed successfully!

✓ RNA pipeline completed successfully!

============================================================
PIPELINE EXECUTION SUMMARY
============================================================
RNA Pipeline: ⚠ PARTIAL
  - preprocessing: ✓
  - cell_type_cluster: ✓
  - dimensionality_reduction: ✓
  - sample_distance_calculation: ✓
  - trajectory_analysis: ✓
  - trajectory_dge: ✗
  - cluster_dge: ✗
  - visualization: ✗

Results saved to: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample
Status file: /dcs07/hongkai/data/harry/result/Benchmark_covid/covid_25_sample/sys_log/main_process_status.json
Execution time: 73.2495 seconds

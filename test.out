Linux system detected with GPU enabled.
Resuming process from previous progress:
{
    "rna": {
        "preprocessing": true,
        "cell_type_cluster": true,
        "dimensionality_reduction": true,
        "sample_distance_calculation": true,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "atac": {
        "preprocessing": false,
        "cell_type_cluster": false,
        "dimensionality_reduction": false,
        "sample_distance_calculation": false,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "multiomics": {
        "glue_integration": false,
        "glue_preprocessing": false,
        "glue_training": false,
        "glue_gene_activity": false,
        "glue_cell_types": true,
        "glue_visualization": false,
        "integration_preprocessing": true,
        "dimensionality_reduction": true,
        "embedding_visualization": true,
        "optimal_resolution": false
    },
    "system_info": {
        "platform": "Linux",
        "python_version": "3.10.18 | packaged by conda-forge | (main, Jun  4 2025, 14:45:41) [GCC 13.3.0]",
        "use_gpu": true,
        "linux_system": true
    }
}

============================================================
RUNNING MULTIOMICS PIPELINE
============================================================
Starting multi-modal pipeline with output directory: /dcs07/hongkai/data/harry/result/multi_omics_ENCODE/multiomics
Initial status flags: {'glue_integration': False, 'glue_preprocessing': False, 'glue_training': False, 'glue_gene_activity': False, 'glue_cell_types': True, 'glue_visualization': False, 'integration_preprocessing': True, 'dimensionality_reduction': True, 'embedding_visualization': True, 'optimal_resolution': False}
Step 1b: Running cell type assignment...

============================================================
Cell Type Assignment for Multi-omics Data
============================================================
[Seed Control] PyTorch GPU deterministic mode enabled with seed=42
[Seed Control] CuPy seed set to 42
[Seed Control] Scanpy seed set to 42

Data composition:
  RNA cells: 427752
  ATAC cells: 430544
  Total cells: 858296

--- Step 1: Clustering RNA cells ---
  Resolution: 0.8
  Building neighborhood graph for RNA cells...
  Performing Leiden clustering...
  Found 42 clusters in RNA cells

--- Step 2: Transferring labels to ATAC cells ---
  Using k=3 nearest neighbors with Jaccard-weighted SNN
  Metric: cosine
  Building k-NN graphs...
  Computing Jaccard-weighted adjacency matrices...
  Computing label predictions...
  Label transfer complete
  Mean transfer confidence: 0.944

--- Step 3: Combining cell type assignments ---
  Cell type assignments complete

  Cell type distribution:
    Cluster 1: RNA=7510, ATAC=3518
    Cluster 10: RNA=4337, ATAC=1872
    Cluster 11: RNA=18163, ATAC=19400
    Cluster 12: RNA=3002, ATAC=3335
    Cluster 13: RNA=11252, ATAC=13858
    Cluster 14: RNA=3474, ATAC=2467
    Cluster 15: RNA=4492, ATAC=4883
    Cluster 16: RNA=24469, ATAC=29898
    Cluster 17: RNA=31198, ATAC=22091
    Cluster 18: RNA=8765, ATAC=8684
    Cluster 19: RNA=8381, ATAC=7133
    Cluster 2: RNA=19821, ATAC=22399
    Cluster 20: RNA=5512, ATAC=2790
    Cluster 21: RNA=6172, ATAC=7865
    Cluster 22: RNA=3876, ATAC=1885
    Cluster 23: RNA=6288, ATAC=2168
    Cluster 24: RNA=5615, ATAC=5283
    Cluster 25: RNA=9200, ATAC=10879
    Cluster 26: RNA=17797, ATAC=12839
    Cluster 27: RNA=15527, ATAC=14469
    Cluster 28: RNA=15745, ATAC=15025
    Cluster 29: RNA=5101, ATAC=6021
    Cluster 3: RNA=5274, ATAC=9087
    Cluster 30: RNA=9054, ATAC=8087
    Cluster 31: RNA=9057, ATAC=10318
    Cluster 32: RNA=13240, ATAC=11700
    Cluster 33: RNA=10584, ATAC=11385
    Cluster 34: RNA=2167, ATAC=5615
    Cluster 35: RNA=9686, ATAC=8188
    Cluster 36: RNA=1158, ATAC=1031
    Cluster 37: RNA=14739, ATAC=11629
    Cluster 38: RNA=681, ATAC=95
    Cluster 39: RNA=1479, ATAC=287
    Cluster 4: RNA=3719, ATAC=3857
    Cluster 40: RNA=6082, ATAC=6205
    Cluster 41: RNA=563, ATAC=213
    Cluster 42: RNA=12402, ATAC=10068
    Cluster 5: RNA=18936, ATAC=24338
    Cluster 6: RNA=30474, ATAC=34965
    Cluster 7: RNA=1547, ATAC=4447
    Cluster 8: RNA=1776, ATAC=3497
    Cluster 9: RNA=39437, ATAC=46770

--- Step 4: Filtering modality-imbalanced clusters ---
[Modality Balance] All clusters balanced, no filtering needed

--- Step 5: Computing UMAP ---

--- Step 6: Generating visualizations ---
  Generating cell type UMAP...
  Generating modality UMAP...
  Generating split modality UMAPs...
  Generating label transfer confidence plot...
  Generating cell type composition heatmap...
  Saved distribution table to: /dcs07/hongkai/data/harry/result/multi_omics_ENCODE/multiomics/visualization/celltype_modality_distribution.csv
  Visualizations complete!
[safe_h5ad_write] Preparing to save to: /dcs07/hongkai/data/harry/result/multi_omics_ENCODE/multiomics/preprocess/atac_rna_integrated.h5ad
[clean_obs_for_saving] Cleaning observation metadata for H5AD compatibility...
[clean_obs_for_saving] Cleaning completed successfully
[clean_obs_for_saving] 4 categorical columns processed
[safe_h5ad_write] Writing H5AD file...

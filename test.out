======================================
 Job ID:            17349991
 Job Name:          test
 Partition:         gpu
 Node List:         compute-170
 CPUs per Task:     16
 Memory Alloc:      819200
 GPU Requested:     1
 Start Time:        Sun Jun 15 09:55:22 AM EDT 2025
======================================
Checking GPU status...
Sun Jun 15 09:55:24 2025       
+-----------------------------------------------------------------------------------------+
| NVIDIA-SMI 555.42.06              Driver Version: 555.42.06      CUDA Version: 12.5     |
|-----------------------------------------+------------------------+----------------------+
| GPU  Name                 Persistence-M | Bus-Id          Disp.A | Volatile Uncorr. ECC |
| Fan  Temp   Perf          Pwr:Usage/Cap |           Memory-Usage | GPU-Util  Compute M. |
|                                         |                        |               MIG M. |
|=========================================+========================+======================|
|   0  NVIDIA H100 NVL                Off |   00000000:D1:00.0 Off |                    0 |
| N/A   43C    P0             90W /  400W |       1MiB /  95830MiB |      3%      Default |
|                                         |                        |             Disabled |
+-----------------------------------------+------------------------+----------------------+
                                                                                         
+-----------------------------------------------------------------------------------------+
| Processes:                                                                              |
|  GPU   GI   CI        PID   Type   Process name                              GPU Memory |
|        ID   ID                                                               Usage      |
|=========================================================================================|
|  No running processes found                                                             |
+-----------------------------------------------------------------------------------------+
Starting main.py...
🚀 GPU acceleration enabled (cuML/CuPy detected)

🧬 Computing gene activity using raw RNA counts and merging data...
   k_neighbors: 10
   metric: cosine
   weight method: cosine similarity
   Processed RNA shape: (898489, 14743)
   Raw RNA shape: (898489, 14881)
   ATAC shape: (88985, 230356)
   ⚠️  Gene indices don't match between processed and raw RNA, aligning...
   Aligned to 14743 common genes
🔍 Finding k-nearest RNA neighbors for each ATAC cell...
   k-NN search completed in 1.27 seconds

📐 Computing cosine similarity weights...
   Cosine similarity computation completed in 0.01 seconds
   Average cosine similarity: 0.9672

🧮 Computing weighted gene activity using raw RNA counts...
   Computing activity for 14743 genes across 88985 ATAC cells
   Progress: 27.8% (5/18 batches)
   Progress: 55.6% (10/18 batches)
   Progress: 83.3% (15/18 batches)
   Gene activity computation completed in 97.81 seconds

🔍 Validating gene activity counts...
   Final count range: [0.000, 11605.010]

📦 Creating gene activity AnnData object...
🔗 Merging gene activity data with raw RNA data...
   Merged shape: (987474, 14743)
   RNA cells: 898489
   ATAC cells: 88985

🏷️  Assigning cell types...
[cell_types] No cell type annotation found. Performing clustering.
[cell_types] Building neighborhood graph...
[cell_types] Target: 10 clusters. Trying resolution: 0.8
[cell_types] Leiden clustering produced 19 clusters.
[cell_types] Got 19 clusters (>= target). Recursing with existing_cell_types=True...
  [cell_types] Current number of cell types: 19
  [cell_types] Aggregating 19 cell types into 10 clusters using dendrogram.
  [cell_types] Using dimension reduction (X_glue) for dendrogram construction...
=== Preparing data for dendrogram (using X_glue) ===
Using all 50 components from X_glue
=== Computing centroids of cell types in X_glue space ===
Calculated centroids for 19 cell types.
Centroid shape: (19, 50)
=== Computing distance matrix between centroids using euclidean distance ===
=== Performing hierarchical clustering on X_glue centroids ===
Linkage method: average, Distance metric: euclidean
=== Aggregating cell types into 10 clusters ===
Successfully created 10 clusters

=== Cluster Composition ===
Cluster 1: 19, 7
Cluster 10: 8
Cluster 2: 4
Cluster 3: 10, 17, 3, 5, 9
Cluster 4: 11, 16
Cluster 5: 12
Cluster 6: 1, 13, 14, 18
Cluster 7: 15
Cluster 8: 6
Cluster 9: 2

=== Cluster Quality Metrics ===
Cluster 1: Average within-cluster distance = 1.3662
Cluster 3: Average within-cluster distance = 1.7271
Cluster 4: Average within-cluster distance = 1.6333
Cluster 6: Average within-cluster distance = 1.7936

Function execution time: 34.32 seconds
  [cell_types] Successfully aggregated to 10 cell types.
[cell_types] Finished assigning cell types.
[cell_types] Converting GPU arrays to CPU...
[cell_types] Total runtime: 69.07 seconds
✅ Gene activity computation and merging complete!

📊 Final Summary:
   Merged dataset shape: (987474, 14743)
   Total cells: 987474
   RNA cells: 898489
   ATAC cells: 88985
   Genes: 14743
   Cell types identified: 10
   GPU acceleration: Yes
   Data corrections: 0 total fixes applied
   Weight method: Cosine similarity
   Expression data: Raw RNA counts
   UMAP visualizations: Generated

Total runtime: 24.23 minutes
Automatically generating harmony subdirectory
=== Read input dataset ===
Dimension of raw data (cells x genes): 987474 x 14743
After basic filtering -- Cells remaining: 985244, Genes remaining: 14250
After remove MT_gene and user input cell -- Cells remaining: 984649, Genes remaining: 14237
Sample counts BEFORE filtering:
sample
HD-16-Yu          12238
HD-7-Wen          11405
HD-9-Wen          11336
CoV-29-Yu         11204
CoV-85.1-Su       11051
                  ...  
CoV-153.2-Su        513
CoV-73.1-SS2        509
SRR14466471         355
re_SRR14466469      344
SRR14466469          17
Length: 432, dtype: int64

Samples retained (>= 500 cells): ['CoV-1.1-Wilk', 'CoV-1.2-Wilk', 'CoV-2-Wilk', 'CoV-3-Wilk', 'CoV-4-Wilk', 'CoV-5-Wilk', 'CoV-7-Wilk', 'CoV-18-Lee', 'CoV-19-Lee', 'CoV-20.2-Lee', 'CoV-21-Lee', 'CoV-22-Lee', 'CoV-23.1-Lee', 'CoV-23.2-Lee', 'CoV-24.1-Lee', 'CoV-24.2-Lee', 'CoV-25-Lee', 'CoV-26.1-Guo', 'CoV-27.1-Guo', 'CoV-28-Yu', 'CoV-29-Yu', 'CoV-30-Yu', 'CoV-31-Yu', 'CoV-32-Yu', 'CoV-33-Yu', 'CoV-34-Aruna', 'CoV-35-Aruna', 'CoV-36-Aruna', 'CoV-37-Aruna', 'CoV-38-Aruna', 'CoV-39-Aruna', 'CoV-40-Aruna', 'CoV-41.1-SS1', 'CoV-41.2-SS1', 'CoV-42.1-SS1', 'CoV-42.2-SS1', 'CoV-43.1-SS1', 'CoV-43.2-SS1', 'CoV-44.2-SS1', 'CoV-45-SS1', 'CoV-46-SS1', 'CoV-47-SS1', 'CoV-48-SS1', 'CoV-49.1-SS1', 'CoV-49.2-SS1', 'CoV-50.1-SS1', 'CoV-50.2-SS1', 'CoV-51-SS1', 'CoV-52.1-SS1', 'CoV-52.2-SS1', 'CoV-53.1-SS1', 'CoV-53.2-SS1', 'CoV-54-SS1', 'CoV-55-SS1', 'CoV-56-SS1', 'CoV-57-SS1', 'CoV-58-SS1', 'CoV-59.1-SS2', 'CoV-59.2-SS2', 'CoV-59.3-SS2', 'CoV-60-SS2', 'CoV-61-SS2', 'CoV-62.1-SS2', 'CoV-62.2-SS2', 'CoV-62.3-SS2', 'CoV-62.4-SS2', 'CoV-63.1-SS2', 'CoV-63.2-SS2', 'CoV-63.3-SS2', 'CoV-63.4-SS2', 'CoV-63.5-SS2', 'CoV-63.6-SS2', 'CoV-63.7-SS2', 'CoV-64.1-SS2', 'CoV-64.2-SS2', 'CoV-64.3-SS2', 'CoV-65.1-SS2', 'CoV-65.2-SS2', 'CoV-67.1-SS2', 'CoV-67.2-SS2', 'CoV-68.1-SS2', 'CoV-68.2-SS2', 'CoV-68.3-SS2', 'CoV-68.4-SS2', 'CoV-69.1-SS2', 'CoV-69.4-SS2', 'CoV-69.6-SS2', 'CoV-70.1-SS2', 'CoV-70.3-SS2', 'CoV-71.1-SS2', 'CoV-71.2-SS2', 'CoV-71.3-SS2', 'CoV-71.4-SS2', 'CoV-72.1-SS2', 'CoV-72.2-SS2', 'CoV-72.3-SS2', 'CoV-73.1-SS2', 'CoV-73.2-SS2', 'CoV-73.3-SS2', 'CoV-74.1-SS2', 'CoV-74.2-SS2', 'CoV-76.5-SS2', 'CoV-77.2-Silvin', 'CoV-79.1-Silvin', 'CoV-82.1-Su', 'CoV-82.2-Su', 'CoV-83.1-Su', 'CoV-83.2-Su', 'CoV-84.1-Su', 'CoV-84.2-Su', 'CoV-85.1-Su', 'CoV-85.2-Su', 'CoV-86.1-Su', 'CoV-86.2-Su', 'CoV-87.1-Su', 'CoV-87.2-Su', 'CoV-88.1-Su', 'CoV-88.2-Su', 'CoV-89.1-Su', 'CoV-90.1-Su', 'CoV-90.2-Su', 'CoV-91.1-Su', 'CoV-91.2-Su', 'CoV-92.1-Su', 'CoV-92.2-Su', 'CoV-93.1-Su', 'CoV-93.2-Su', 'CoV-94.1-Su', 'CoV-94.2-Su', 'CoV-95-Su', 'CoV-96.1-Su', 'CoV-96.2-Su', 'CoV-97.1-Su', 'CoV-97.2-Su', 'CoV-98.1-Su', 'CoV-98.2-Su', 'CoV-99.2-Su', 'CoV-100.1-Su', 'CoV-100.2-Su', 'CoV-101.1-Su', 'CoV-101.2-Su', 'CoV-102.1-Su', 'CoV-102.2-Su', 'CoV-103.1-Su', 'CoV-103.2-Su', 'CoV-104.1-Su', 'CoV-104.2-Su', 'CoV-105.1-Su', 'CoV-105.2-Su', 'CoV-106.1-Su', 'CoV-106.2-Su', 'CoV-107.1-Su', 'CoV-107.2-Su', 'CoV-108.1-Su', 'CoV-108.2-Su', 'CoV-109.1-Su', 'CoV-109.2-Su', 'CoV-110.1-Su', 'CoV-110.2-Su', 'CoV-111.1-Su', 'CoV-111.2-Su', 'CoV-112.1-Su', 'CoV-112.2-Su', 'CoV-113.1-Su', 'CoV-113.2-Su', 'CoV-114.1-Su', 'CoV-114.2-Su', 'CoV-115.1-Su', 'CoV-115.2-Su', 'CoV-116.1-Su', 'CoV-116.2-Su', 'CoV-117.1-Su', 'CoV-117.2-Su', 'CoV-118.2-Su', 'CoV-119.1-Su', 'CoV-119.2-Su', 'CoV-120.1-Su', 'CoV-120.2-Su', 'CoV-121.2-Su', 'CoV-122.2-Su', 'CoV-123.1-Su', 'CoV-123.2-Su', 'CoV-124.2-Su', 'CoV-125-Su', 'CoV-126.1-Su', 'CoV-126.2-Su', 'CoV-127.1-Su', 'CoV-127.2-Su', 'CoV-128.1-Su', 'CoV-128.2-Su', 'CoV-129.1-Su', 'CoV-129.2-Su', 'CoV-130.1-Su', 'CoV-130.2-Su', 'CoV-132.1-Su', 'CoV-132.2-Su', 'CoV-133.1-Su', 'CoV-133.2-Su', 'CoV-134.1-Su', 'CoV-134.2-Su', 'CoV-135.1-Su', 'CoV-135.2-Su', 'CoV-136.1-Su', 'CoV-136.2-Su', 'CoV-137.1-Su', 'CoV-137.2-Su', 'CoV-138.1-Su', 'CoV-138.2-Su', 'CoV-139.1-Su', 'CoV-139.2-Su', 'CoV-140.1-Su', 'CoV-140.2-Su', 'CoV-141.1-Su', 'CoV-141.2-Su', 'CoV-142.1-Su', 'CoV-142.2-Su', 'CoV-143.1-Su', 'CoV-143.2-Su', 'CoV-144.1-Su', 'CoV-144.2-Su', 'CoV-145.1-Su', 'CoV-145.2-Su', 'CoV-146.1-Su', 'CoV-146.2-Su', 'CoV-147.1-Su', 'CoV-148.1-Su', 'CoV-149.1-Su', 'CoV-149.2-Su', 'CoV-150.1-Su', 'CoV-150.2-Su', 'CoV-151.1-Su', 'CoV-151.2-Su', 'CoV-152.1-Su', 'CoV-152.2-Su', 'CoV-153.1-Su', 'CoV-153.2-Su', 'CoV-154.2-Su', 'CoV-155.1-Su', 'CoV-155.2-Su', 'CoV-156.1-Su', 'CoV-156.2-Su', 'CoV-157.1-Su', 'CoV-157.2-Su', 'CoV-158.1-Su', 'CoV-158.2-Su', 'CoV-159.1-Su', 'CoV-159.2-Su', 'CoV-160.1-Su', 'CoV-160.2-Su', 'CoV-161.1-Su', 'CoV-161.2-Su', 'CoV-162.1-Su', 'CoV-162.2-Su', 'CoV-163.1-Su', 'CoV-163.2-Su', 'CoV-164.1-Su', 'CoV-164.2-Su', 'CoV-165.1-Su', 'CoV-165.2-Su', 'CoV-166.2-Su', 'CoV-167.2-Su', 'CoV-168.1-Su', 'CoV-169.1-Su', 'CoV-169.2-Su', 'CoV-170.1-Su', 'CoV-171.1-Su', 'CoV-171.2-Su', 'CoV-172.1-Su', 'CoV-172.2-Su', 'CoV-173.1-Su', 'CoV-173.2-Su', 'CoV-174.2-Su', 'CoV-175.1-Su', 'CoV-175.2-Su', 'CoV-176.1-Su', 'CoV-176.2-Su', 'CoV-177.2-Su', 'CoV-179.1-Su', 'CoV-179.2-Su', 'CoV-180.1-Su', 'CoV-180.2-Su', 'CoV-181.1-Su', 'CoV-181.2-Su', 'CoV-182.1-Su', 'CoV-182.2-Su', 'CoV-183.1-Su', 'CoV-183.2-Su', 'CoV-184.1-Su', 'CoV-184.2-Su', 'CoV-185.1-Su', 'CoV-185.2-Su', 'CoV-186.1-Su', 'CoV-186.2-Su', 'CoV-187.1-Su', 'CoV-187.2-Su', 'CoV-188.1-Su', 'CoV-188.2-Su', 'CoV-189.1-Su', 'CoV-189.2-Su', 'CoV-190.1-Su', 'CoV-190.2-Su', 'CoV-191.1-Su', 'CoV-191.2-Su', 'CoV-192.1-Su', 'CoV-192.2-Su', 'CoV-193.1-Su', 'CoV-193.2-Su', 'CoV-194.1-Su', 'CoV-194.2-Su', 'CoV-195.1-Su', 'CoV-195.2-Su', 'CoV-196.1-Su', 'CoV-196.2-Su', 'CoV-197.1-Su', 'CoV-197.2-Su', 'CoV-198.1-Su', 'CoV-198.2-Su', 'CoV-199.1-Su', 'CoV-199.2-Su', 'CoV-200.2-Su', 'CoV-201.2-Su', 'CoV-202.2-Su', 'CoV-203.1-Su', 'CoV-203.2-Su', 'CoV-204.1-Su', 'CoV-204.2-Su', 'CoV-205.1-Su', 'CoV-205.2-Su', 'CoV-206.1-Su', 'CoV-206.2-Su', 'CoV-207.1-Su', 'CoV-207.2-Su', 'CoV-208.1-Su', 'CoV-208.2-Su', 'CoV-209.1-Su', 'CoV-210.1-Su', 'CoV-210.2-Su', 'CoV-211.1-Zhu', 'CoV-211.2-Zhu', 'CoV-212.2-Zhu', 'CoV-212.3-Zhu', 'CoV-212.5-Zhu', 'CoV-213.1-Zhu', 'CoV-213.2-Zhu', 'CoV-214.1-Zhu', 'CoV-214.2-Zhu', 'CoV-215.1-Zhu', 'CoV-215.3-Zhu', 'CoV-216-Mudd', 'CoV-217-Mudd', 'CoV-218-Mudd', 'HD-1-Wilk', 'HD-2-Wilk', 'HD-3-Wilk', 'HD-4-Wilk', 'HD-5-Wilk', 'HD-6-Wilk', 'HD-7-Wen', 'HD-8-Wen', 'HD-9-Wen', 'HD-10-Wen', 'HD-11-Wen', 'HD-12-Lee', 'HD-13-Lee', 'HD-14-Lee', 'HD-15-Lee', 'HD-16-Yu', 'HD-17-Yu', 'HD-18-Yu', 'HD-19-Aruna', 'HD-20-Aruna', 'HD-21-Aruna', 'HD-22-Aruna', 'HD-23-Aruna', 'HD-24-SS2', 'HD-28-SS2', 'HD-29-SS2', 'HD-30-SS2', 'HD-31-SS2', 'HD-32-SS2', 'HD-33-SS2', 'HD-35-SS2', 'HD-36-SS2', 'HD-37-SS2', 'HD-39-SS2', 'HD-43-Su', 'HD-44-Su', 'HD-45-Su', 'HD-46-Su', 'HD-47-Su', 'HD-48-Su', 'HD-49-Su', 'HD-50-Su', 'HD-51-Su', 'HD-52-Su', 'HD-53-Su', 'HD-54-Su', 'HD-55-Su', 'HD-56-Su', 'HD-57-Su', 'HD-58-Su', 'HD-58-Zhu', 'HD-59-Zhu', 'HD-60-Zhu', 'HD-61-Mudd', 'SRR14466459', 'SRR14466460', 'SRR14466461', 'SRR14466462', 'SRR14466463', 'SRR14466464', 'SRR14466465', 'SRR14466466', 'SRR14466467', 'SRR14466468', 'SRR14466470', 'SRR14466472', 'SRR14466473', 'SRR14466474', 'SRR14466475', 'SRR14466476', 'SRR14466477', 'SRR14466478', 'SRR14466479', 'SRR14466480', 'SRR14466481', 'SRR14466482', 'SRR14466483', 're_SRR14466471']

Sample counts AFTER filtering:
sample
HD-16-Yu        12238
HD-7-Wen        11405
HD-9-Wen        11336
CoV-29-Yu       11204
CoV-85.1-Su     11051
                ...  
CoV-53.1-SS1      522
CoV-203.1-Su      520
CoV-102.1-Su      520
CoV-153.2-Su      513
CoV-73.1-SS2      509
Name: count, Length: 429, dtype: int64
Final filtering -- Cells remaining: 983933, Genes remaining: 10867
Preprocessing complete!
Function execution time: 4061.11 seconds
[process_anndata_with_pca] Starting dimension reduction computation...
[process_anndata_with_pca] Results will be stored under unified keys:
  - X_DR_expression: for expression data
  - X_DR_proportion: for proportion data
[process_anndata_with_pca] RNA mode: Will use PCA for expression data
[process_anndata_with_pca] Using n_expression_pcs=10, n_proportion_pcs=9
[DimRed] Computing PCA for RNA data with 10 components on (429, 2000) data
[PCA] Success. Shape: (429, 10)
[Storage] Stored X_DR_expression in both adata and pseudobulk_anndata (shape: (429, 10))
[Storage] Stored X_pca_expression_method in both adata and pseudobulk_anndata (shape: (429, 10))
[PCA] Stored variance information in both objects
[DimRed] Completed - results stored as X_DR_expression in both adata and pseudobulk_anndata
[run_pca_proportion] PCA on cell proportions completed.
Stored results as X_DR_proportion in both adata and pseudobulk_anndata with shape: (429, 9)
[process_anndata_with_pca] AnnData with dimension reduction results saved to: /dcl01/hongkai/data/data/hjiang/result/k10/integration/preprocess/atac_rna_integrated.h5ad
[process_anndata_with_pca] Pseudobulk AnnData with dimension reduction results saved to: /dcl01/hongkai/data/data/hjiang/result/k10/integration/pseudobulk/pseudobulk_sample.h5ad
[process_anndata_with_pca] Total runtime for dimension reduction: 817.56 seconds
[process_anndata_with_pca] All results are now available under unified keys:
  - X_DR_expression and X_DR_proportion in both adata.uns and pseudobulk_anndata.uns
Creating multimodal embedding visualization for ATAC
Coloring by: current_severity
Expression key: X_DR_expression
Proportion key: X_DR_proportion
Automatically generating visualization output_dir

Detected data type for current_severity: numerical
Detected data type for current_severity: numerical
Expression plot saved to: /dcl01/hongkai/data/data/hjiang/result/k10/integration/visualization/ATAC_current_severity_expression.png
Detected data type for current_severity: numerical
Proportion plot saved to: /dcl01/hongkai/data/data/hjiang/result/k10/integration/visualization/ATAC_current_severity_proportion.png
Separate plots saved: ['/dcl01/hongkai/data/data/hjiang/result/k10/integration/visualization/ATAC_current_severity_expression.png', '/dcl01/hongkai/data/data/hjiang/result/k10/integration/visualization/ATAC_current_severity_proportion.png']
Finished main.py.
End Time: Sun Jun 15 11:42:06 AM EDT 2025

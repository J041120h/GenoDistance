Linux system detected with GPU enabled.
Resuming process from previous progress:
{
    "rna": {
        "preprocessing": false,
        "cell_type_cluster": false,
        "dimensionality_reduction": false,
        "sample_distance_calculation": false,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "atac": {
        "preprocessing": false,
        "cell_type_cluster": false,
        "dimensionality_reduction": false,
        "sample_distance_calculation": false,
        "trajectory_analysis": false,
        "trajectory_dge": false,
        "cluster_dge": false,
        "visualization": false
    },
    "multiomics": {
        "glue_integration": false,
        "glue_preprocessing": false,
        "glue_training": false,
        "glue_gene_activity": false,
        "glue_cell_types": false,
        "glue_visualization": false,
        "integration_preprocessing": false,
        "dimensionality_reduction": false,
        "embedding_visualization": false,
        "optimal_resolution": false
    },
    "system_info": {
        "platform": "Linux",
        "python_version": "3.10.13 | packaged by conda-forge | (main, Dec 23 2023, 15:36:39) [GCC 12.3.0]",
        "use_gpu": true,
        "linux_system": true
    }
}

============================================================
RUNNING MULTIOMICS PIPELINE
============================================================
Starting multi-modal pipeline with output directory: /dcs07/hongkai/data/harry/result/Benchmark/multiomics
Initial status flags: {'glue_integration': False, 'glue_preprocessing': False, 'glue_training': False, 'glue_gene_activity': False, 'glue_cell_types': False, 'glue_visualization': False, 'integration_preprocessing': False, 'dimensionality_reduction': False, 'embedding_visualization': False, 'optimal_resolution': False}
Step 1: Running GLUE integration...
  Sub-steps: Preprocessing=True, Training=True, Gene Activity=True, Cell Types=True, Visualization=False
Running preprocessing...

üöÄ Starting GLUE preprocessing pipeline...

   Feature selection mode: Highly Variable

üìä Loading data files...
   RNA: /dcl01/hongkai/data/data/hjiang/Data/paired/rna/all.h5ad
   ATAC: /dcl01/hongkai/data/data/hjiang/Data/paired/atac/all.h5ad
‚úÖ Data loaded successfully
   RNA shape: (430595, 36601)
   ATAC shape: (430595, 3576085)

üìã Standardizing existing sample columns...
‚úÖ Sample column standardization complete

üß¨ Setting up Ensembl annotation...
   Release: 98
   Species: homo_sapiens
‚úÖ Ensembl annotation ready

üß¨ Preprocessing scRNA-seq data...
   Selecting 1500 highly variable genes

üìù Processing additional HVG genes from: /dcl01/hongkai/data/data/hjiang/Data/multi_omics_testing/unique_genes.txt
   Found 1624 genes in additional HVG file
   Statistics for additional HVG genes:
     - Genes found and marked as HVG: 1624/1624
   Computing 50 PCA components
‚úÖ RNA preprocessing complete

üèîÔ∏è Preprocessing scATAC-seq data...
   Computing feature statistics for peak selection
   Selected 50000 highly accessible peaks
   Computing 50 LSI components (15 iterations)
‚úÖ ATAC preprocessing complete

üó∫Ô∏è Processing gene coordinates...
   Processing 36601 genes...
   ‚ö†Ô∏è Could not find coordinates for genes: TBCE.1, LINC01238.1, CYB561D2.1, MATR3.1, LINC01505.1, HSPA14.1, GOLGA8M.1, GGT1.1, ARMCX5-GPRASP2.1, TMSB15B.1
   Filtered out 10 genes without coordinates
‚úÖ Gene coordinate processing complete
   36591 genes retained
   Final RNA shape: (430595, 36591)

üèîÔ∏è Processing ATAC peak coordinates...
   Processing 3576085 peaks...
‚úÖ ATAC peak coordinates extracted successfully

üï∏Ô∏è Constructing guidance graph...
   Using highly variable features for graph construction
[INFO] check_graph: Checking variable coverage...
[INFO] check_graph: Checking edge attributes...
[INFO] check_graph: Checking self-loops...
[INFO] check_graph: Checking graph symmetry...
[INFO] check_graph: All checks passed!
‚úÖ Guidance graph constructed successfully
   Nodes: 3,612,676
   Edges: 9,027,876

üßπ Preparing data for saving...

üßπ Cleaning AnnData for saving...
   Input shape: (430595, 36591)
   X is dense, shape=(430595, 36591)
   Cleaning 1 layers...
   Cleaning complete!

üßπ Cleaning AnnData for saving...
   Input shape: (430595, 3576085)
   Large matrix detected (nnz=3,825,322,475), keeping int64 indices
   X matrix: CSR, dtype=float64, nnz=3,825,322,475
   Cleaning complete!
üíæ Saving preprocessed data...
   Output directory: /dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue
   Saving RNA data...
   Saving ATAC data...
   Saving guidance graph...

üéâ GLUE preprocessing pipeline completed successfully!

Preprocessing completed.
Running training...



üöÄ Starting GLUE training pipeline...



   Feature mode: Highly Variable Only
   Output directory: /dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue




üìä Loading preprocessed data from /dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue...






Data loaded - RNA: (430595, 36591), ATAC: (430595, 3576085), Graph: 3612676 nodes






‚öôÔ∏è Configuring datasets...






üîç Extracting highly variable feature subgraph...



HVF subgraph extracted - RNA HVF: 2697, ATAC HVF: 476292
HVF graph: 478989 nodes, 1449835 edges






ü§ñ Training GLUE model...



[INFO] fit_SCGLUE: Pretraining SCGLUE model...
[INFO] autodevice: Using GPU 0 as computation device.
[INFO] check_graph: Checking variable coverage...
[INFO] check_graph: Checking edge attributes...
[INFO] check_graph: Checking self-loops...
[INFO] check_graph: Checking graph symmetry...
[INFO] SCGLUEModel: Setting `graph_batch_size` = 498381
[INFO] SCGLUEModel: Setting `patience` = 4
[INFO] SCGLUEModel: Setting `reduce_lr_patience` = 2
[INFO] SCGLUETrainer: Using training directory: "/dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue/training/pretrain"
[INFO] LRScheduler: Learning rate reduction: step 1
[INFO] SCGLUETrainer: [Epoch 10] train={'g_nll': 0.393, 'g_kl': 0.0, 'g_elbo': 0.393, 'x_rna_nll': 0.263, 'x_rna_kl': 0.01, 'x_rna_elbo': 0.273, 'x_atac_nll': 0.012, 'x_atac_kl': 0.0, 'x_atac_elbo': 0.012, 'dsc_loss': 0.693, 'vae_loss': 0.301, 'gen_loss': 0.266}, val={'g_nll': 0.392, 'g_kl': 0.0, 'g_elbo': 0.393, 'x_rna_nll': 0.26, 'x_rna_kl': 0.01, 'x_rna_elbo': 0.27, 'x_atac_nll': 0.012, 'x_atac_kl': 0.0, 'x_atac_elbo': 0.012, 'dsc_loss': 0.692, 'vae_loss': 0.297, 'gen_loss': 0.263}, 1628.7s elapsed
[INFO] LRScheduler: Learning rate reduction: step 2
[INFO] EarlyStopping: Restoring checkpoint "15"...
[INFO] EarlyStopping: Restoring checkpoint "15"...
[INFO] fit_SCGLUE: Estimating balancing weight...
[INFO] estimate_balancing_weight: Clustering cells...
[INFO] estimate_balancing_weight: Matching clusters...
[INFO] estimate_balancing_weight: Matching array shape = (63, 27)...
[INFO] estimate_balancing_weight: Estimating balancing weight...
[INFO] fit_SCGLUE: Fine-tuning SCGLUE model...
[INFO] check_graph: Checking variable coverage...
[INFO] check_graph: Checking edge attributes...
[INFO] check_graph: Checking self-loops...
[INFO] check_graph: Checking graph symmetry...
[INFO] SCGLUEModel: Setting `graph_batch_size` = 498381
[INFO] SCGLUEModel: Setting `align_burnin` = 8
[INFO] SCGLUEModel: Setting `patience` = 4
[INFO] SCGLUEModel: Setting `reduce_lr_patience` = 2
[INFO] SCGLUETrainer: Using training directory: "/dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue/training/fine-tune"
[INFO] SCGLUETrainer: [Epoch 10] train={'g_nll': 0.394, 'g_kl': 0.0, 'g_elbo': 0.395, 'x_rna_nll': 0.265, 'x_rna_kl': 0.01, 'x_rna_elbo': 0.275, 'x_atac_nll': 0.012, 'x_atac_kl': 0.0, 'x_atac_elbo': 0.012, 'dsc_loss': 0.673, 'vae_loss': 0.302, 'gen_loss': 0.268}, val={'g_nll': 0.395, 'g_kl': 0.0, 'g_elbo': 0.395, 'x_rna_nll': 0.262, 'x_rna_kl': 0.01, 'x_rna_elbo': 0.272, 'x_atac_nll': 0.012, 'x_atac_kl': 0.0, 'x_atac_elbo': 0.012, 'dsc_loss': 0.68, 'vae_loss': 0.299, 'gen_loss': 0.265}, 1644.4s elapsed
[INFO] LRScheduler: Learning rate reduction: step 1
[INFO] SCGLUETrainer: [Epoch 20] train={'g_nll': 0.392, 'g_kl': 0.0, 'g_elbo': 0.392, 'x_rna_nll': 0.263, 'x_rna_kl': 0.01, 'x_rna_elbo': 0.273, 'x_atac_nll': 0.012, 'x_atac_kl': 0.0, 'x_atac_elbo': 0.012, 'dsc_loss': 0.684, 'vae_loss': 0.3, 'gen_loss': 0.266}, val={'g_nll': 0.392, 'g_kl': 0.0, 'g_elbo': 0.392, 'x_rna_nll': 0.26, 'x_rna_kl': 0.01, 'x_rna_elbo': 0.27, 'x_atac_nll': 0.012, 'x_atac_kl': 0.0, 'x_atac_elbo': 0.012, 'dsc_loss': 0.67, 'vae_loss': 0.297, 'gen_loss': 0.264}, 1641.5s elapsed
[INFO] LRScheduler: Learning rate reduction: step 2
[INFO] EarlyStopping: Restoring checkpoint "23"...
[INFO] EarlyStopping: Restoring checkpoint "23"...



üé® Generating embeddings...






üíæ Saving results to /dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue...






üìä Checking integration consistency...



[INFO] integration_consistency: Using layer "counts" for modality "rna"
[INFO] integration_consistency: Selecting aggregation "sum" for modality "rna"
[INFO] integration_consistency: Selecting aggregation "sum" for modality "atac"
[INFO] integration_consistency: Selecting log-norm preprocessing for modality "rna"
[INFO] integration_consistency: Selecting log-norm preprocessing for modality "atac"
[INFO] get_metacells: Clustering metacells...
[INFO] get_metacells: Aggregating metacells...
[INFO] metacell_corr: Computing correlation on 10 common metacells...
[INFO] get_metacells: Clustering metacells...
[INFO] get_metacells: Aggregating metacells...
[INFO] metacell_corr: Computing correlation on 20 common metacells...
[INFO] get_metacells: Clustering metacells...
[INFO] get_metacells: Aggregating metacells...
[INFO] metacell_corr: Computing correlation on 50 common metacells...
[INFO] get_metacells: Clustering metacells...
[INFO] get_metacells: Aggregating metacells...
[INFO] metacell_corr: Computing correlation on 100 common metacells...
[INFO] get_metacells: Clustering metacells...
[INFO] get_metacells: Aggregating metacells...
[INFO] metacell_corr: Computing correlation on 197 common metacells...



Consistency scores - Min: 0.1559, Mean: 0.2713






üìà Integration Assessment:
Feature mode: Highly Variable
Consistency threshold: 0.05
Minimum consistency: 0.1559
Status: ‚úÖ RELIABLE






üéâ GLUE training pipeline completed successfully!
Results saved to: /dcs07/hongkai/data/harry/result/Benchmark/multiomics/integration/glue



Training completed.
Computing gene activity...

üß¨ Computing gene activity using raw RNA counts (optimized for large matrices)...
   k_neighbors: 200
   metric: cosine
   GPU acceleration: enabled
   Available GPU memory: 45.75 GB
   Available CPU memory: 712.60 GB
üìÇ Loading processed RNA embeddings...
üìÇ Loading ATAC embeddings...
üìÇ Loading raw RNA counts...
